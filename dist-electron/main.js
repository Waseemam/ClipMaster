"use strict";const h=require("electron"),_=require("path"),D=require("fs"),T=require("child_process"),j=require("tty"),G=require("util"),W=require("net");class H{constructor(){this.db=null,this.dbPath=null,this.initialized=!1}async initialize(){if(this.initialized)return;const e=h.app.getPath("userData");if(this.dbPath=_.join(e,"clipmaster.json"),console.log("Database path:",this.dbPath),D.existsSync(this.dbPath)){const r=D.readFileSync(this.dbPath,"utf8");this.db=JSON.parse(r),console.log("Loaded existing database")}else this.db={notes:[],clipboard_history:[],folders:[],tags:[],nextId:{notes:1,clipboard:1,folders:1,tags:1}},this.save(),console.log("Created new database");this.initialized=!0}save(){!this.db||!this.dbPath||D.writeFileSync(this.dbPath,JSON.stringify(this.db,null,2),"utf8")}getNotes(e={}){let r=[...this.db.notes];if(e.folderId&&(r=r.filter(i=>i.folder_id===e.folderId)),e.search){const i=e.search.toLowerCase();r=r.filter(s=>s.title.toLowerCase().includes(i)||s.content.toLowerCase().includes(i))}return r.sort((i,s)=>new Date(s.updated_at)-new Date(i.updated_at)),e.limit&&(r=r.slice(0,parseInt(e.limit))),r}getNote(e){return this.db.notes.find(r=>r.id===e)||null}createNote(e){const{title:r,content:i,folderId:s,tags:p}=e,o={id:this.db.nextId.notes++,title:r,content:i,folder_id:s||null,tags:p||[],created_at:new Date().toISOString(),updated_at:new Date().toISOString()};return this.db.notes.push(o),this.save(),o}updateNote(e,r){const{title:i,content:s,folderId:p,tags:o}=r,c=this.db.notes.find(t=>t.id===e);return c?(c.title=i,c.content=s,c.folder_id=p||null,o!==void 0&&(c.tags=o),c.updated_at=new Date().toISOString(),this.save(),c):null}deleteNote(e){const r=this.db.notes.findIndex(i=>i.id===e);return r===-1?!1:(this.db.notes.splice(r,1),this.save(),!0)}getTags(){const e=new Set;return this.db.notes.forEach(r=>{r.tags&&r.tags.forEach(i=>e.add(i))}),Array.from(e).map(r=>({id:r,name:r,usage_count:this.db.notes.filter(i=>i.tags&&i.tags.includes(r)).length}))}getFolders(){return this.db.folders.map(e=>({...e,note_count:this.db.notes.filter(r=>r.folder_id===e.id).length}))}createFolder(e){const{name:r,color:i}=e,s={id:this.db.nextId.folders++,name:r,color:i||null,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};return this.db.folders.push(s),this.save(),s}updateFolder(e,r){const{name:i,color:s}=r,p=this.db.folders.find(o=>o.id===e);return p?(p.name=i,p.color=s||null,p.updated_at=new Date().toISOString(),this.save(),p):null}deleteFolder(e){const r=this.db.folders.findIndex(i=>i.id===e);return r===-1?!1:(this.db.folders.splice(r,1),this.save(),!0)}getClipboardHistory(e={}){let r=[...this.db.clipboard_history];if(e.type&&(r=r.filter(s=>s.type===e.type)),e.search){const s=e.search.toLowerCase();r=r.filter(p=>p.title&&p.title.toLowerCase().includes(s)||p.content.toLowerCase().includes(s))}r.sort((s,p)=>new Date(p.created_at)-new Date(s.created_at));const i=e.limit?parseInt(e.limit):1e3;return r.slice(0,i)}saveClipboardItem(e){const{content:r,type:i,title:s}=e,o=this.db.clipboard_history.slice(0,50).find(t=>t.content===r&&t.type===i);if(o)return o.created_at=new Date().toISOString(),s&&(o.title=s),this.save(),o;const c={id:this.db.nextId.clipboard++,content:r,type:i,title:s||null,created_at:new Date().toISOString()};return this.db.clipboard_history.unshift(c),this.save(),c}deleteClipboardItem(e){const r=this.db.clipboard_history.findIndex(i=>i.id===e);return r===-1?!1:(this.db.clipboard_history.splice(r,1),this.save(),!0)}clearClipboardHistory(){const e=this.db.clipboard_history.length;return this.db.clipboard_history=[],this.save(),e}search(e){const r=e.toLowerCase(),i=[];return this.db.notes.forEach(s=>{(s.title.toLowerCase().includes(r)||s.content.toLowerCase().includes(r))&&i.push({type:"note",id:s.id,name:s.title,preview:s.content.substring(0,100),created_at:s.created_at})}),this.db.clipboard_history.slice(0,100).forEach(s=>{(s.title&&s.title.toLowerCase().includes(r)||s.content.toLowerCase().includes(r))&&i.push({type:"clipboard",id:s.id,name:s.title||s.content.substring(0,50),preview:s.content.substring(0,100),created_at:s.created_at})}),i.slice(0,50)}close(){this.db&&this.save()}}function J(d){return d&&d.__esModule&&Object.prototype.hasOwnProperty.call(d,"default")?d.default:d}var C={exports:{}},S={exports:{}},I={exports:{}},E,N;function V(){if(N)return E;N=1;var d=1e3,e=d*60,r=e*60,i=r*24,s=i*365.25;E=function(n,a){a=a||{};var u=typeof n;if(u==="string"&&n.length>0)return p(n);if(u==="number"&&isNaN(n)===!1)return a.long?c(n):o(n);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(n))};function p(n){if(n=String(n),!(n.length>100)){var a=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(n);if(a){var u=parseFloat(a[1]),m=(a[2]||"ms").toLowerCase();switch(m){case"years":case"year":case"yrs":case"yr":case"y":return u*s;case"days":case"day":case"d":return u*i;case"hours":case"hour":case"hrs":case"hr":case"h":return u*r;case"minutes":case"minute":case"mins":case"min":case"m":return u*e;case"seconds":case"second":case"secs":case"sec":case"s":return u*d;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return u;default:return}}}}function o(n){return n>=i?Math.round(n/i)+"d":n>=r?Math.round(n/r)+"h":n>=e?Math.round(n/e)+"m":n>=d?Math.round(n/d)+"s":n+"ms"}function c(n){return t(n,i,"day")||t(n,r,"hour")||t(n,e,"minute")||t(n,d,"second")||n+" ms"}function t(n,a,u){if(!(n<a))return n<a*1.5?Math.floor(n/a)+" "+u:Math.ceil(n/a)+" "+u+"s"}return E}var L;function R(){return L||(L=1,(function(d,e){e=d.exports=s.debug=s.default=s,e.coerce=t,e.disable=o,e.enable=p,e.enabled=c,e.humanize=V(),e.names=[],e.skips=[],e.formatters={};var r;function i(n){var a=0,u;for(u in n)a=(a<<5)-a+n.charCodeAt(u),a|=0;return e.colors[Math.abs(a)%e.colors.length]}function s(n){function a(){if(a.enabled){var u=a,m=+new Date,f=m-(r||m);u.diff=f,u.prev=r,u.curr=m,r=m;for(var l=new Array(arguments.length),y=0;y<l.length;y++)l[y]=arguments[y];l[0]=e.coerce(l[0]),typeof l[0]!="string"&&l.unshift("%O");var g=0;l[0]=l[0].replace(/%([a-zA-Z%])/g,function(w,U){if(w==="%%")return w;g++;var M=e.formatters[U];if(typeof M=="function"){var B=l[g];w=M.call(u,B),l.splice(g,1),g--}return w}),e.formatArgs.call(u,l);var v=a.log||e.log||console.log.bind(console);v.apply(u,l)}}return a.namespace=n,a.enabled=e.enabled(n),a.useColors=e.useColors(),a.color=i(n),typeof e.init=="function"&&e.init(a),a}function p(n){e.save(n),e.names=[],e.skips=[];for(var a=(typeof n=="string"?n:"").split(/[\s,]+/),u=a.length,m=0;m<u;m++)a[m]&&(n=a[m].replace(/\*/g,".*?"),n[0]==="-"?e.skips.push(new RegExp("^"+n.substr(1)+"$")):e.names.push(new RegExp("^"+n+"$")))}function o(){e.enable("")}function c(n){var a,u;for(a=0,u=e.skips.length;a<u;a++)if(e.skips[a].test(n))return!1;for(a=0,u=e.names.length;a<u;a++)if(e.names[a].test(n))return!0;return!1}function t(n){return n instanceof Error?n.stack||n.message:n}})(I,I.exports)),I.exports}var z;function x(){return z||(z=1,(function(d,e){e=d.exports=R(),e.log=s,e.formatArgs=i,e.save=p,e.load=o,e.useColors=r,e.storage=typeof chrome<"u"&&typeof chrome.storage<"u"?chrome.storage.local:c(),e.colors=["lightseagreen","forestgreen","goldenrod","dodgerblue","darkorchid","crimson"];function r(){return typeof window<"u"&&window.process&&window.process.type==="renderer"?!0:typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}e.formatters.j=function(t){try{return JSON.stringify(t)}catch(n){return"[UnexpectedJSONParseError]: "+n.message}};function i(t){var n=this.useColors;if(t[0]=(n?"%c":"")+this.namespace+(n?" %c":" ")+t[0]+(n?"%c ":" ")+"+"+e.humanize(this.diff),!!n){var a="color: "+this.color;t.splice(1,0,a,"color: inherit");var u=0,m=0;t[0].replace(/%[a-zA-Z%]/g,function(f){f!=="%%"&&(u++,f==="%c"&&(m=u))}),t.splice(m,0,a)}}function s(){return typeof console=="object"&&console.log&&Function.prototype.apply.call(console.log,console,arguments)}function p(t){try{t==null?e.storage.removeItem("debug"):e.storage.debug=t}catch{}}function o(){var t;try{t=e.storage.debug}catch{}return!t&&typeof process<"u"&&"env"in process&&(t=process.env.DEBUG),t}e.enable(o());function c(){try{return window.localStorage}catch{}}})(S,S.exports)),S.exports}var q={exports:{}},F;function Z(){return F||(F=1,(function(d,e){var r=j,i=G;e=d.exports=R(),e.init=m,e.log=t,e.formatArgs=c,e.save=n,e.load=a,e.useColors=o,e.colors=[6,2,3,4,5,1],e.inspectOpts=Object.keys(process.env).filter(function(f){return/^debug_/i.test(f)}).reduce(function(f,l){var y=l.substring(6).toLowerCase().replace(/_([a-z])/g,function(v,w){return w.toUpperCase()}),g=process.env[l];return/^(yes|on|true|enabled)$/i.test(g)?g=!0:/^(no|off|false|disabled)$/i.test(g)?g=!1:g==="null"?g=null:g=Number(g),f[y]=g,f},{});var s=parseInt(process.env.DEBUG_FD,10)||2;s!==1&&s!==2&&i.deprecate(function(){},"except for stderr(2) and stdout(1), any other usage of DEBUG_FD is deprecated. Override debug.log if you want to use a different log function (https://git.io/debug_fd)")();var p=s===1?process.stdout:s===2?process.stderr:u(s);function o(){return"colors"in e.inspectOpts?!!e.inspectOpts.colors:r.isatty(s)}e.formatters.o=function(f){return this.inspectOpts.colors=this.useColors,i.inspect(f,this.inspectOpts).split(`
`).map(function(l){return l.trim()}).join(" ")},e.formatters.O=function(f){return this.inspectOpts.colors=this.useColors,i.inspect(f,this.inspectOpts)};function c(f){var l=this.namespace,y=this.useColors;if(y){var g=this.color,v="  \x1B[3"+g+";1m"+l+" \x1B[0m";f[0]=v+f[0].split(`
`).join(`
`+v),f.push("\x1B[3"+g+"m+"+e.humanize(this.diff)+"\x1B[0m")}else f[0]=new Date().toUTCString()+" "+l+" "+f[0]}function t(){return p.write(i.format.apply(i,arguments)+`
`)}function n(f){f==null?delete process.env.DEBUG:process.env.DEBUG=f}function a(){return process.env.DEBUG}function u(f){var l,y=process.binding("tty_wrap");switch(y.guessHandleType(f)){case"TTY":l=new r.WriteStream(f),l._type="tty",l._handle&&l._handle.unref&&l._handle.unref();break;case"FILE":var g=D;l=new g.SyncWriteStream(f,{autoClose:!1}),l._type="fs";break;case"PIPE":case"TCP":var v=W;l=new v.Socket({fd:f,readable:!1,writable:!0}),l.readable=!1,l.read=null,l._type="pipe",l._handle&&l._handle.unref&&l._handle.unref();break;default:throw new Error("Implement me. Unknown stream file type!")}return l.fd=f,l._isStdio=!0,l}function m(f){f.inspectOpts={};for(var l=Object.keys(e.inspectOpts),y=0;y<l.length;y++)f.inspectOpts[l[y]]=e.inspectOpts[l[y]]}e.enable(a())})(q,q.exports)),q.exports}var k;function Y(){return k||(k=1,typeof process<"u"&&process.type==="renderer"?C.exports=x():C.exports=Z()),C.exports}var O,A;function K(){if(A)return O;A=1;var d=_,e=T.spawn,r=Y()("electron-squirrel-startup"),i=h.app,s=function(o,c){var t=d.resolve(d.dirname(process.execPath),"..","Update.exe");r("Spawning `%s` with args `%s`",t,o),e(t,o,{detached:!0}).on("close",c)},p=function(){if(process.platform==="win32"){var o=process.argv[1];r("processing squirrel command `%s`",o);var c=d.basename(process.execPath);if(o==="--squirrel-install"||o==="--squirrel-updated")return s(["--createShortcut="+c],i.quit),!0;if(o==="--squirrel-uninstall")return s(["--removeShortcut="+c],i.quit),!0;if(o==="--squirrel-obsolete")return i.quit(),!0}return!1};return O=p(),O}var Q=K();const X=J(Q);X&&h.app.quit();let b;const P=()=>{const d=new h.BrowserWindow({width:1400,height:900,minWidth:1e3,minHeight:600,frame:!1,backgroundColor:"#2f3136",icon:_.join(__dirname,"../build/icon.png"),webPreferences:{preload:_.join(__dirname,"preload.js"),nodeIntegration:!1,contextIsolation:!0}});process.env.VITE_DEV_SERVER_URL?d.loadURL(process.env.VITE_DEV_SERVER_URL):d.loadFile(_.join(__dirname,"../dist/index.html")),h.ipcMain.on("window-minimize",()=>{d.minimize()}),h.ipcMain.on("window-maximize",()=>{d.isMaximized()?d.unmaximize():d.maximize()}),h.ipcMain.on("window-close",()=>{d.close()}),d.on("maximize",()=>{d.webContents.send("window-maximized")}),d.on("unmaximize",()=>{d.webContents.send("window-unmaximized")});let e="",r="",i;const s=()=>{i=setInterval(()=>{const o=h.clipboard.readText(),c=h.clipboard.readImage();if(o&&o!==e&&o.length>0)e=o,r="",d.webContents.send("clipboard-change",{type:"text",content:o,timestamp:new Date().toISOString()});else if(!c.isEmpty()&&!o){const t=c.toDataURL();t!==r&&(r=t,e="",d.webContents.send("clipboard-change",{type:"image",content:t,timestamp:new Date().toISOString()}))}},500)},p=()=>{i&&clearInterval(i)};h.ipcMain.on("start-clipboard-monitoring",()=>{s()}),h.ipcMain.on("stop-clipboard-monitoring",()=>{p()}),s(),d.on("closed",()=>{p()}),h.ipcMain.handle("db:getNotes",async(o,c)=>{try{return{success:!0,data:b.getNotes(c)}}catch(t){return console.error("Get notes error:",t),{success:!1,error:t.message}}}),h.ipcMain.handle("db:getNote",async(o,c)=>{try{return{success:!0,data:b.getNote(c)}}catch(t){return console.error("Get note error:",t),{success:!1,error:t.message}}}),h.ipcMain.handle("db:createNote",async(o,c)=>{try{return{success:!0,data:b.createNote(c)}}catch(t){return console.error("Create note error:",t),{success:!1,error:t.message}}}),h.ipcMain.handle("db:updateNote",async(o,c,t)=>{try{return{success:!0,data:b.updateNote(c,t)}}catch(n){return console.error("Update note error:",n),{success:!1,error:n.message}}}),h.ipcMain.handle("db:deleteNote",async(o,c)=>{try{const t=b.deleteNote(c);return{success:t,data:{deleted:t}}}catch(t){return console.error("Delete note error:",t),{success:!1,error:t.message}}}),h.ipcMain.handle("db:getFolders",async()=>{try{return{success:!0,data:b.getFolders()}}catch(o){return console.error("Get folders error:",o),{success:!1,error:o.message}}}),h.ipcMain.handle("db:createFolder",async(o,c)=>{try{return{success:!0,data:b.createFolder(c)}}catch(t){return console.error("Create folder error:",t),{success:!1,error:t.message}}}),h.ipcMain.handle("db:getTags",async()=>{try{return{success:!0,data:b.getTags()}}catch(o){return console.error("Get tags error:",o),{success:!1,error:o.message}}}),h.ipcMain.handle("db:getClipboardHistory",async(o,c)=>{try{return{success:!0,data:{items:b.getClipboardHistory(c)}}}catch(t){return console.error("Get clipboard history error:",t),{success:!1,error:t.message}}}),h.ipcMain.handle("db:saveClipboardItem",async(o,c)=>{try{return{success:!0,data:b.saveClipboardItem(c)}}catch(t){return console.error("Save clipboard item error:",t),{success:!1,error:t.message}}}),h.ipcMain.handle("db:deleteClipboardItem",async(o,c)=>{try{const t=b.deleteClipboardItem(c);return{success:t,data:{deleted:t}}}catch(t){return console.error("Delete clipboard item error:",t),{success:!1,error:t.message}}}),h.ipcMain.handle("db:clearClipboardHistory",async()=>{try{return{success:!0,data:{count:b.clearClipboardHistory()}}}catch(o){return console.error("Clear clipboard history error:",o),{success:!1,error:o.message}}}),h.ipcMain.handle("db:search",async(o,c)=>{try{return{success:!0,data:b.search(c)}}catch(t){return console.error("Search error:",t),{success:!1,error:t.message}}})};h.app.whenReady().then(async()=>{try{b=new H,await b.initialize(),console.log("Database initialized successfully")}catch(d){console.error("Failed to initialize database:",d)}h.app.setLoginItemSettings({openAtLogin:!0,openAsHidden:!1,path:process.execPath,args:[]}),P(),h.app.on("activate",()=>{h.BrowserWindow.getAllWindows().length===0&&P()})});h.app.on("window-all-closed",()=>{process.platform!=="darwin"&&h.app.quit()});h.app.on("before-quit",()=>{b&&(b.close(),console.log("Database connection closed"))});
